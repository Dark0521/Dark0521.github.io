<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>âœ¨ å¿ƒè¯­ Â· å¿ƒç†è‡ªè¯„</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    /* åŸºç¡€æ ·å¼ */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      background: linear-gradient(135deg, #f8fafc 0%, #e0e7ff 100%);
      color: #1f2937;
      line-height: 1.6;
      padding: 16px;
      min-height: 100vh;
    }
    
    /* å®¹å™¨ */
    .container {
      max-width: 720px;
      margin: 0 auto;
      background: white;
      border-radius: 24px;
      box-shadow: 0 12px 40px rgba(0, 20, 60, 0.12);
      overflow: hidden;
    }
    
    /* é¡¶éƒ¨è£…é¥° */
    .header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 40px 30px 30px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }
    
    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      border-radius: 50%;
    }
    
    .header h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 8px;
      position: relative;
      z-index: 1;
    }
    
    .header p {
      font-size: 16px;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }
    
    /* æ ‡ç­¾åˆ‡æ¢ */
    .scale-tabs {
      display: flex;
      gap: 10px;
      margin: 20px;
      padding: 8px;
      background: #f3f4f6;
      border-radius: 16px;
    }
    
    .scale-tab {
      flex: 1;
      padding: 12px 16px;
      text-align: center;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      transition: all 0.2s;
      color: #6b7280;
    }
    
    .scale-tab.active {
      background: white;
      color: #6366f1;
      box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
    }
    
    /* å†…å®¹åŒºåŸŸ */
    .content {
      padding: 25px;
    }
    
    /* é¢˜ç›®æ ·å¼ */
    .question {
      background: #f9fafb;
      border-radius: 16px;
      padding: 18px;
      margin-bottom: 16px;
      border: 1px solid #e5e7eb;
      transition: all 0.2s;
    }
    
    .question:hover {
      border-color: #d1d5db;
      transform: translateY(-1px);
    }
    
    .question-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 12px;
      color: #111827;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .question-title::before {
      content: '';
      display: inline-block;
      width: 6px;
      height: 6px;
      background: #6366f1;
      border-radius: 50%;
    }
    
    .question-text {
      font-size: 15px;
      color: #4b5563;
      line-height: 1.5;
      margin-bottom: 14px;
    }
    
    /* é€‰é¡¹æ ·å¼ - ä¼˜åŒ–å°ºå¯¸ */
    .options {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    
    @media (max-width: 550px) {
      .options { grid-template-columns: repeat(2, 1fr); }
    }
    
    .option {
      padding: 10px 6px;
      border: 2px solid #e5e7eb;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 13px;
      background: white;
      min-height: 60px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 4px;
    }
    
    .option-value {
      font-weight: 700;
      font-size: 18px;
      color: #6366f1;
    }
    
    .option-text {
      font-size: 12px;
      color: #4b5563;
      line-height: 1.3;
    }
    
    .option:hover {
      border-color: #a78bfa;
      background: #f5f3ff;
    }
    
    .option.selected {
      border-color: #6366f1;
      background: #eef2ff;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }
    
    .option.selected .option-value {
      color: #4338ca;
    }
    
    /* è¿›åº¦æ¡ */
    .progress {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 25px 0;
    }
    
    .progress-text {
      font-size: 14px;
      color: #6366f1;
      font-weight: 600;
      min-width: 80px;
    }
    
    .progress-bar {
      flex: 1;
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 3px;
      width: 0%;
      transition: width 0.3s ease;
    }
    
    /* æäº¤æŒ‰é’® */
    .submit-btn {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      border: none;
      padding: 14px 24px;
      border-radius: 14px;
      font-size: 16px;
      font-weight: 600;
      width: 100%;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }
    
    .submit-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      box-shadow: none;
    }
    
    .submit-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4);
    }
    
    /* ç»“æœåŒºåŸŸ */
    .result {
      text-align: center;
      padding: 30px 20px;
      border-radius: 20px;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
      margin-top: 20px;
      border: 1px solid #bae6fd;
      display: none;
    }
    
    .result.show {
      display: block;
      animation: fadeIn 0.4s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .result-title {
      font-size: 22px;
      font-weight: 700;
      color: #0c4a6e;
      margin-bottom: 15px;
    }
    
    .score {
      font-size: 42px;
      font-weight: 800;
      color: #1e40af;
      margin: 10px 0;
      line-height: 1;
    }
    
    .level {
      font-size: 18px;
      font-weight: 700;
      margin: 12px 0;
      color: #1e3a8a;
    }
    
    .suggestion {
      font-size: 15px;
      margin: 20px 0;
      line-height: 1.7;
      color: #0f172a;
      padding: 15px;
      background: white;
      border-radius: 12px;
      border-left: 4px solid #6366f1;
    }
    
    .disclaimer {
      font-size: 13px;
      color: #4b5563;
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px dashed #93c5fd;
    }
    
    /* è¿”å›æŒ‰é’® */
    .back-btn {
      display: inline-block;
      margin-top: 25px;
      padding: 10px 24px;
      background: white;
      color: #6366f1;
      border: 2px solid #6366f1;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: #6366f1;
      color: white;
    }
    
    /* åº•éƒ¨ */
    .footer {
      text-align: center;
      margin-top: 30px;
      color: #6b7280;
      font-size: 13px;
      padding: 15px;
      border-top: 1px solid #f3f4f6;
    }
    
    /* å“åº”å¼ä¼˜åŒ– */
    @media (max-width: 480px) {
      .header h1 { font-size: 26px; }
      .header p { font-size: 14px; }
      .content { padding: 20px 16px; }
      .question { padding: 14px; }
      .question-title { font-size: 15px; }
      .scale-tabs { margin: 15px; }
      .option { padding: 8px 4px; min-height: 55px; }
      .option-value { font-size: 16px; }
      .option-text { font-size: 11px; }
      .score { font-size: 36px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨ -->
    <div class="header">
      <h1>âœ¨ å¿ƒè¯­å¿ƒç†è‡ªè¯„</h1>
      <p>ä¸“ä¸šé‡è¡¨ Â· 5åˆ†é’Ÿå®Œæˆ Â· ç»“æœå®æ—¶è§£è¯»</p>
    </div>

    <!-- æ ‡ç­¾åˆ‡æ¢ -->
    <div class="scale-tabs">
      <div class="scale-tab active" data-scale="phq9">ğŸ˜” æŠ‘éƒç­›æŸ¥</div>
      <div class="scale-tab" data-scale="gad7">ğŸ˜° ç„¦è™‘ç­›æŸ¥</div>
    </div>

    <!-- å†…å®¹åŒºåŸŸ -->
    <div class="content">
      <div id="phq9-container">
        <!-- PHQ-9é¢˜ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>
      <div id="gad7-container" style="display:none;">
        <!-- GAD-7é¢˜ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
      </div>

      <!-- è¿›åº¦æ¡ -->
      <div class="progress">
        <div class="progress-text" id="progress-text">0/9 å·²å®Œæˆ</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill"></div>
        </div>
      </div>

      <!-- æäº¤æŒ‰é’® -->
      <button class="submit-btn" id="submit-btn" disabled>âœ… å®Œæˆæµ‹è¯„ï¼ŒæŸ¥çœ‹ç»“æœ</button>

            <!-- ç»“æœåŒºåŸŸ -->
      <div class="result" id="result">
        <div class="result-title">âœ… æµ‹è¯„å®Œæˆ</div>
        <div class="score" id="score-display">--</div>
        <div class="level" id="level-display">--</div>
        <div class="suggestion" id="suggestion-display">--</div>
        <div class="disclaimer">
          ğŸ’¡ æ¸©é¦¨æç¤ºï¼šç­›æŸ¥â‰ è¯Šæ–­ï¼Œç»“æœéœ€ç”±æŒè¯å¿ƒç†å’¨è¯¢å¸ˆè¯„ä¼°
        </div>
        <a href="javascript:window.close();" class="back-btn">
          â† å…³é—­æœ¬é¡µé¢è¿”å›èŠå¤©
        </a>
        <p style="font-size:13px; color:#6b7280; margin-top:10px;">
          ğŸ’¡ å°æç¤ºï¼šå…³é—­æœ¬é¡µé¢å³å¯è‡ªåŠ¨å›åˆ°èŠå¤©ç•Œé¢
        </p>
      </div>

    <!-- åº•éƒ¨ -->
    <div class="footer">
      <p>Â© 2026 é«˜æ ¡å¿ƒç†å¥åº·ä¸­å¿ƒ Â· æ•°æ®ä»…ç”¨äºæœ¬æ¬¡æµ‹è¯„ï¼Œ7å¤©åè‡ªåŠ¨æ¸…é™¤</p>
    </div>
  </div>

  <script>
    // ========== é‡è¡¨æ•°æ® ==========
    const PHQ9_QUESTIONS = [
      "åšä»€ä¹ˆäº‹éƒ½æä¸èµ·å…´è¶£æˆ–ä¹è¶£ï¼Ÿ",
      "æ„Ÿåˆ°å¿ƒæƒ…ä½è½ã€æ²®ä¸§æˆ–ç»æœ›ï¼Ÿ",
      "å…¥ç¡å›°éš¾ã€ç¡ä¸å®‰ç¨³æˆ–ç¡å¤ªå¤šï¼Ÿ",
      "æ„Ÿè§‰ç–²å€¦æˆ–æ²¡æœ‰æ´»åŠ›ï¼Ÿ",
      "é£Ÿæ¬²ä¸æŒ¯æˆ–åƒå¤ªå¤šï¼Ÿ",
      "è§‰å¾—è‡ªå·±å¾ˆç³Ÿï¼Œæˆ–è®©å®¶äººå¤±æœ›ï¼Ÿ",
      "æ³¨æ„åŠ›éš¾ä»¥é›†ä¸­ï¼ˆå¦‚çœ‹æŠ¥çº¸ã€çœ‹ç”µè§†ï¼‰ï¼Ÿ",
      "åŠ¨ä½œæˆ–è¯´è¯é€Ÿåº¦ç¼“æ…¢ï¼Œæˆ–çƒ¦èºä¸å®‰ï¼Ÿ",
      "æœ‰ä¸å¦‚æ­»æ‰æˆ–ç”¨æŸç§æ–¹å¼ä¼¤å®³è‡ªå·±çš„å¿µå¤´ï¼Ÿ"
    ];

    const GAD7_QUESTIONS = [
      "æ„Ÿåˆ°ç´§å¼ ã€ç„¦è™‘æˆ–çƒ¦èºï¼Ÿ",
      "ä¸èƒ½åœæ­¢æˆ–æ§åˆ¶æ‹…å¿§ï¼Ÿ",
      "å¯¹å¾ˆå¤šäº‹æƒ…æ‹…å¿§ï¼Ÿ",
      "éš¾ä»¥æ”¾æ¾ï¼Ÿ",
      "å˜å¾—å®¹æ˜“çƒ¦èºæˆ–æ€¥èºï¼Ÿ",
      "æ„Ÿåˆ°å®³æ€•ï¼Œå¥½åƒæœ‰ä»€ä¹ˆå¯æ€•çš„äº‹æƒ…è¦å‘ç”Ÿï¼Ÿ",
      "å› ç„¦è™‘è€Œéš¾ä»¥é™åï¼Ÿ"
    ];

    // ========== çŠ¶æ€ç®¡ç† ==========
    let currentScale = 'phq9';
    let answers = Array(9).fill(-1);
    const sessionId = new URLSearchParams(window.location.search).get('session_id') || 'user_' + Date.now();

    // ========== åˆå§‹åŒ– ==========
    function init() {
      // 1. ç»‘å®šé‡è¡¨åˆ‡æ¢
      document.querySelectorAll('.scale-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.scale-tab').forEach(t => t.classList.remove('active'));
          tab.classList.add('active');
          
          currentScale = tab.dataset.scale;
          document.getElementById('phq9-container').style.display = currentScale === 'phq9' ? 'block' : 'none';
          document.getElementById('gad7-container').style.display = currentScale === 'gad7' ? 'block' : 'none';
          
          // é‡ç½®ç­”æ¡ˆ
          const totalQuestions = currentScale === 'phq9' ? 9 : 7;
          answers = Array(totalQuestions).fill(-1);
          updateProgress();
          document.getElementById('submit-btn').disabled = true;
          
          // é‡æ–°æ¸²æŸ“é¢˜ç›®
          renderQuestions();
        });
      });
      
      // 2. æ¸²æŸ“åˆå§‹é¢˜ç›®
      renderQuestions();
      
      // 3. ç»‘å®šæäº¤æŒ‰é’®
      document.getElementById('submit-btn').addEventListener('click', submitTest);
      // 4åˆ é™¤è¿™æ®µä»£ç 
document.getElementById('back-chat').addEventListener('click', (e) => {
  e.preventDefault();
  const chatUrl = localStorage.getItem('dify_chat_url') || 'https://your-dify-chat.com';
  window.open(chatUrl, '_blank');
});
 

    // ========== æ¸²æŸ“é¢˜ç›® ==========
    function renderQuestions() {
      const containerId = currentScale === 'phq9' ? 'phq9-container' : 'gad7-container';
      const questions = currentScale === 'phq9' ? PHQ9_QUESTIONS : GAD7_QUESTIONS;
      
      let html = '';
      questions.forEach((q, i) => {
        html += `
          <div class="question">
            <div class="question-title">ç¬¬${i+1}é¢˜</div>
            <div class="question-text">${q}</div>
            <div class="options" id="q${i}">
              <div class="option" data-value="0">
                <div class="option-value">0</div>
                <div class="option-text">å®Œå…¨ä¸ä¼š</div>
              </div>
              <div class="option" data-value="1">
                <div class="option-value">1</div>
                <div class="option-text">å‡ å¤©</div>
              </div>
              <div class="option" data-value="2">
                <div class="option-value">2</div>
                <div class="option-text">ä¸€åŠä»¥ä¸Šæ—¥å­</div>
              </div>
              <div class="option" data-value="3">
                <div class="option-value">3</div>
                <div class="option-text">å‡ ä¹æ¯å¤©</div>
              </div>
            </div>
          </div>
        `;
      });
      
      document.getElementById(containerId).innerHTML = html;
      
      // ç»‘å®šé€‰é¡¹ç‚¹å‡»
      questions.forEach((_, i) => {
        document.querySelectorAll(`#q${i} .option`).forEach(opt => {
          opt.addEventListener('click', () => {
            // å–æ¶ˆåŒé¢˜å…¶ä»–é€‰é¡¹
            document.querySelectorAll(`#q${i} .option`).forEach(o => o.classList.remove('selected'));
            // é€‰ä¸­å½“å‰
            opt.classList.add('selected');
            answers[i] = parseInt(opt.dataset.value);
            // æ›´æ–°è¿›åº¦
            updateProgress();
          });
        });
      });
    }

    // ========== æ›´æ–°è¿›åº¦ ==========
    function updateProgress() {
      const total = currentScale === 'phq9' ? 9 : 7;
      const completed = answers.filter(a => a !== -1).length;
      const percent = Math.round((completed / total) * 100);
      
      document.getElementById('progress-text').textContent = `${completed}/${total} å·²å®Œæˆ`;
      document.getElementById('progress-fill').style.width = `${percent}%`;
      
      // æ£€æŸ¥æ˜¯å¦å…¨éƒ¨å®Œæˆ
      document.getElementById('submit-btn').disabled = completed < total;
    }

    // ========== æäº¤æµ‹è¯„ ==========
    async function submitTest() {
      const total = currentScale === 'phq9' ? 9 : 7;
      const score = answers.slice(0, total).reduce((a, b) => a + b, 0);
      const scaleName = currentScale === 'phq9' ? 'PHQ-9' : 'GAD-7';
      
      // 1. è°ƒç”¨Dify APIï¼ˆå·²é…ç½®æ‚¨çš„å®é™…APIï¼‰
      try {
        document.getElementById('submit-btn').disabled = true;
        document.getElementById('submit-btn').textContent = 'ğŸ”„ æ­£åœ¨åˆ†æ...';
        
        // ============ å…³é”®é…ç½® ============
        const response = await fetch('http://192.168.118.248/v1/chat-messages', {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer app-4O8o8axCccHpRT4EOKQcpavk',
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            inputs: {},
            query: `ç”¨æˆ·å·²å®Œæˆ${scaleName}å¿ƒç†æµ‹è¯•ï¼Œé‡è¡¨ï¼š${scaleName}ï¼Œæ€»åˆ†ï¼š${score}åˆ†`,
            response_mode: "blocking",
            user: sessionId,
            conversation_id: sessionId
          })
        });
        
        const data = await response.json();
        const aiResponse = data.answer || 'åˆ†æå®Œæˆ';
        
        // 2. è§£æAIå›å¤
        displayResult(score, aiResponse);
        
      } catch (error) {
        console.error('APIè°ƒç”¨å¤±è´¥:', error);
        alert('ç»“æœåˆ†æå¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è¿”å›èŠå¤©ç•Œé¢ã€‚é”™è¯¯ï¼š' + error.message);
        document.getElementById('submit-btn').disabled = false;
        document.getElementById('submit-btn').textContent = 'âœ… å®Œæˆæµ‹è¯„ï¼ŒæŸ¥çœ‹ç»“æœ';
      }
    }

    // ========== æ˜¾ç¤ºç»“æœ ==========
    function displayResult(score, aiResponse) {
      let level = '', suggestion = '';
      
      if (score <= 4) {
        level = 'ğŸ˜Š æƒ…ç»ªçŠ¶æ€å¹³ç¨³';
        suggestion = 'ç»§ç»­ä¿æŒè§„å¾‹ä½œæ¯å’Œé€‚åº¦è¿åŠ¨å°±å¥½ï½';
      } else if (score <= 9) {
        level = 'ğŸŒ± è½»åº¦æƒ…ç»ªæ³¢åŠ¨';
        suggestion = 'å»ºè®®æ¯å¤©15åˆ†é’Ÿæˆ·å¤–æ•£æ­¥ï¼ŒæŒç»­2å‘¨æ— æ”¹å–„å¯é¢„çº¦å’¨è¯¢';
      } else if (score <= 14) {
        level = 'ğŸ’™ ä¸­åº¦æƒ…ç»ªæ³¢åŠ¨';
        suggestion = 'å»ºè®®48å°æ—¶å†…é¢„çº¦å­¦æ ¡å¿ƒç†å’¨è¯¢ï¼ˆé“¾æ¥ï¼‰';
      } else {
        level = 'âš ï¸ éœ€è¦ä¸“ä¸šæ”¯æŒ';
        suggestion = 'å·²é€šçŸ¥å¿ƒç†è€å¸ˆï¼Œ5åˆ†é’Ÿå†…ä¼šæœ‰è€å¸ˆè”ç³»ä½ ';
      }
      
      // æ˜¾ç¤ºç»“æœ
      document.getElementById('score-display').textContent = `${score}åˆ†`;
      document.getElementById('level-display').textContent = level;
      document.getElementById('suggestion-display').innerHTML = suggestion + '<br><br>' + 
        aiResponse.replace(/\n/g, '<br>').replace(/###/g, '');
      
      document.getElementById('result').classList.add('show');
      
      // æ»šåŠ¨åˆ°ç»“æœ
      document.getElementById('result').scrollIntoView({ behavior: 'smooth' });
    }

    // ========== é¡µé¢åŠ è½½ ==========
    window.addEventListener('DOMContentLoaded', () => {
      const chatUrl = new URLSearchParams(window.location.search).get('chat_url');
      if (chatUrl) {
        localStorage.setItem('dify_chat_url', chatUrl);
        document.getElementById('back-chat').href = chatUrl;
      }
      
      init();
    });
  </script>
</body>
</html>



